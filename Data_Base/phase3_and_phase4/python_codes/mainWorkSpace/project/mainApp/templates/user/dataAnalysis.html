{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      href="{% static 'mainApp/images/logo.png' %}"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Analysis</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #1d1f20, #383a3b);
        color: #fff;
        font-family: "Roboto", sans-serif;
      }
      .header {
        width: 100%;
        background: #1a1c1d;
        padding: 20px;
        text-align: center;
        font-size: 24px;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .header span {
        font-weight: 500;
      }
      .button {
        cursor: pointer;
        background: #e74c3c;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-size: 16px;
        padding: 10px 20px;
        transition: background 0.3s;
        margin: 0 10px;
      }
      .button:hover {
        background: #c0392b;
      }
      .content {
        margin-top: 100px;
        width: 90%;
        max-width: 1200px;
      }
      .chart-container,
      .pie-chart-container,
      .service-chart-container {
        width: 100%;
        height: 400px;
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: relative;
      }
      .buttons {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      .buttons-container,
      .dropdown-container {
        display: flex;
        justify-content: center;
        position: absolute;
        top: 10px;
        right: 20px;
      }
      select {
        background: #1a1c1d;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 10px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <span>Data Analysis</span>
      <button class="button" onclick="goback()">Back to Control Panel</button>
    </div>
    <div class="content">
      <div class="chart-container">
        <div class="buttons-container">
          <button class="button" onclick="loadData(2)">Past 1 Year</button>
          <button class="button" onclick="loadData(5)">Past 4 Years</button>
          <button class="button" onclick="loadData(11)">Past 10 Years</button>
        </div>
        <canvas id="combinedChart"></canvas>
      </div>
      <div class="pie-chart-container">
        <div class="dropdown-container">
          <select id="yearSelect" onchange="loadPieChart()">
            <!-- Options will be populated by JavaScript -->
          </select>
        </div>
        <canvas id="messagesPieChart"></canvas>
      </div>
      <div class="service-chart-container">
        <canvas id="serviceUsageChart"></canvas>
      </div>
    </div>
    <script>
      function goback() {
        window.location.href = "{% url 'control' %}";
      }

      let combinedChart;
      let messagesPieChart;
      let serviceUsageChart;

      let visitYearsData,
        visitCountsData,
        appointmentYearsData,
        appointmentCountsData,
        serviceNames,
        serviceCounts;
      let messageYearsData,
        smsCountsData,
        notificationCountsData,
        emailCountsData;

      visitYearsData = JSON.parse("{{ visit_years|escapejs }}");
      visitCountsData = JSON.parse("{{ visit_counts|escapejs }}");
      appointmentYearsData = JSON.parse("{{ appointment_years|escapejs }}");
      appointmentCountsData = JSON.parse("{{ appointment_counts|escapejs }}");
      serviceNames = JSON.parse("{{ service_names|escapejs }}");
      serviceCounts = JSON.parse("{{ service_counts|escapejs }}");
      messageYearsData = JSON.parse("{{ message_years|escapejs }}");
      smsCountsData = JSON.parse("{{ sms_counts|escapejs }}");
      notificationCountsData = JSON.parse("{{ notification_counts|escapejs }}");
      emailCountsData = JSON.parse("{{ email_counts|escapejs }}");

      console.log("Parsed Data:", {
        visitYearsData,
        visitCountsData,
        appointmentYearsData,
        appointmentCountsData,
        serviceNames,
        serviceCounts,
        messageYearsData,
        smsCountsData,
        notificationCountsData,
        emailCountsData,
      });

      function loadData(years) {
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - years + 1;

        const filteredYears = [];
        const filteredVisits = [];
        const filteredAppointments = [];

        const visitsMap = new Map();
        for (let i = 0; i < visitYearsData.length; i++) {
          visitsMap.set(visitYearsData[i], visitCountsData[i]);
        }

        const appointmentsMap = new Map();
        for (let i = 0; i < appointmentYearsData.length; i++) {
          appointmentsMap.set(
            appointmentYearsData[i],
            appointmentCountsData[i]
          );
        }

        for (let year = startYear; year <= currentYear; year++) {
          filteredYears.push(year);
          filteredVisits.push(visitsMap.get(year) || 0);
          filteredAppointments.push(appointmentsMap.get(year) || 0);
        }

        const combinedChartData = {
          labels: filteredYears,
          datasets: [
            {
              label: "Visits",
              data: filteredVisits,
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
            },
            {
              label: "Appointments",
              data: filteredAppointments,
              backgroundColor: "rgba(192, 75, 75, 0.2)",
              borderColor: "rgba(192, 75, 75, 1)",
              borderWidth: 1,
            },
          ],
        };

        if (combinedChart) {
          combinedChart.destroy();
        }

        const ctxCombined = document
          .getElementById("combinedChart")
          .getContext("2d");
        combinedChart = new Chart(ctxCombined, {
          type: "line",
          data: combinedChartData,
          options: {
            responsive: true,
            scales: {
              x: { beginAtZero: true },
              y: { beginAtZero: true },
            },
          },
        });

        // service usage chart
        const serviceUsageChartData = {
          labels: serviceNames,
          datasets: [
            {
              label: "Service Usage",
              data: serviceCounts,
              backgroundColor: getRandomColors(serviceNames.length),
              borderColor: getRandomColors(serviceNames.length),
              borderWidth: 1,
            },
          ],
        };

        if (serviceUsageChart) {
          serviceUsageChart.destroy();
        }

        const ctxServiceUsage = document
          .getElementById("serviceUsageChart")
          .getContext("2d");
        serviceUsageChart = new Chart(ctxServiceUsage, {
          type: "bar",
          data: serviceUsageChartData,
          options: {
            responsive: true,
            scales: {
              x: { beginAtZero: true },
              y: { beginAtZero: true },
            },
          },
        });
      }

      loadData(2);

      function loadPieChart() {
        const selectedYear = parseInt(
          document.getElementById("yearSelect").value
        );
        const yearIndex = messageYearsData.indexOf(selectedYear);

        const messageTypesData = {
          labels: ["SMS", "Notification", "Email"],
          datasets: [
            {
              label: "Messages",
              data: [
                smsCountsData[yearIndex],
                notificationCountsData[yearIndex],
                emailCountsData[yearIndex],
              ],
              backgroundColor: [
                "rgba(54, 162, 235, 0.2)",
                "rgba(255, 206, 86, 0.2)",
                "rgba(75, 192, 192, 0.2)",
              ],
              borderColor: [
                "rgba(54, 162, 235, 1)",
                "rgba(255, 206, 86, 1)",
                "rgba(75, 192, 192, 1)",
              ],
              borderWidth: 1,
            },
          ],
        };

        if (messagesPieChart) {
          messagesPieChart.destroy();
        }

        const ctxMessagesPie = document
          .getElementById("messagesPieChart")
          .getContext("2d");
        messagesPieChart = new Chart(ctxMessagesPie, {
          type: "pie",
          data: messageTypesData,
          options: { responsive: true },
        });
      }

      // populate year select options and load initial pie chart with the first available year
      document.addEventListener("DOMContentLoaded", () => {
        const yearSelect = document.getElementById("yearSelect");
        messageYearsData.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
        loadPieChart();
      });

      function getRandomColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
          colors.push(getRandomColor());
        }
        return colors;
      }

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
    </script>
  </body>
</html>
