{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      href="{% static 'mainApp/images/logo.png' %}"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Treatment Records</title>
    <style>
      html,
      body {
        overflow-x: hidden;
        height: 100%;
      }

      .modal-lg {
        max-width: 90%;
      }

      .modal-body table {
        width: 100%;
        overflow-x: auto;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }

      .container {
        padding-top: 60px;
      }

      .button-container {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-bottom: 20px;
      }

      .button {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        white-space: nowrap;
      }

      .header {
        position: sticky;
        top: 0;
        z-index: 1000;
        width: 100%;
        background-color: #333;
        color: white;
        padding: 10px 20px;
      }

      .container {
        padding-top: 70px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .button-container {
        display: flex;
        flex-wrap: wrap;
      }

      .toggle-button {
        cursor: pointer;
        background-color: #4caf50;
        border: none;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
      }

      h1 {
        color: #333;
        display: inline-block;
        margin-right: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        text-align: left;
        padding: 8px;
        border: 1px solid #ddd;
      }

      th {
        background-color: #4caf50;
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      .button {
        padding: 10px 20px;
        margin-top: 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .container {
        padding-top: 60px;
      }

      .toggle-button {
        cursor: pointer;
        background-color: #4caf50;
        border: none;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var submitButton = document.getElementById("submitQueryButton");
        if (submitButton) {
          submitButton.addEventListener("click", processNLQuery);
        }
      });

      function processNLQuery() {
        const query = document.getElementById("nlQueryInput").value;
        const url = "{% url 'process_query' %}";
        console.log("URL being called:", url);

        fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ query: query }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("Query result:", data.result);
              const resultTableBody = document.getElementById(
                "queryResultTableBody"
              );
              const resultBox = document.getElementById("queryResultBox");
              resultTableBody.innerHTML = "";
              resultBox.innerHTML = "";

              if (data.result.length === 1) {
                const singleResult = data.result[0];
                for (const key in singleResult) {
                  const div = document.createElement("div");
                  div.innerHTML = `<strong>${key}:</strong> ${singleResult[key]}`;
                  resultBox.appendChild(div);
                }
                $("#queryResultsModal").modal("show");
                $("#queryResultsModal .modal-body").hide();
                $("#queryResultsModal .modal-body-single").show();
              } else {
                data.result.forEach((record) => {
                  const row = document.createElement("tr");
                  row.innerHTML = `
                                    <td>${record["Record_ID"]}</td>
                                    <td>${record["Visit_ID"]}</td>
                                    <td>${record["Description"]}</td>
                                `;
                  resultTableBody.appendChild(row);
                });
                $("#queryResultsModal").modal("show");
                $("#queryResultsModal .modal-body").show();
                $("#queryResultsModal .modal-body-single").hide();
              }
            } else {
              alert("Failed to process query: " + data.error);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      function submitUpdate() {
        var recordData = {
          old_visit_id: document.getElementById("modal-old-visit-id").value,
          visit_id: document.getElementById("modal-visit-id").value,
          description: document.getElementById("modal-description").value,
        };

        fetch("{% url 'update_treatment_record' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
          body: JSON.stringify(recordData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              $("#updateTreatmentRecordModal").modal("hide");
              window.location.reload();
            } else {
              alert("Failed to update treatment record.");
            }
          });
      }

      function gotoadd() {
        window.location.href = "{% url 'add_treatment_record' %}";
      }

      function goback() {
        window.location.href = "{% url 'control' %}";
      }

      function toggleTable() {
        var table = document.getElementById("treatmentRecordTable");
        var btn = document.getElementById("toggleButton");
        if (table.style.display === "none") {
          table.style.display = "";
          btn.textContent = "Hide";
        } else {
          table.style.display = "none";
          btn.textContent = "Show";
        }
      }

      function selectRow(row) {
        var checkbox = row.getElementsByTagName("input")[0];
        checkbox.checked = !checkbox.checked;
        row.style.backgroundColor = checkbox.checked ? "#f8d7da" : "";
      }

      function deleteSelectedRecords() {
        var selected = document.querySelectorAll(
          'input[name="selected_record"]:checked'
        );
        var recordIds = Array.from(selected).map((input) => input.value);

        if (
          recordIds.length > 0 &&
          confirm("Are you sure you want to delete selected records?")
        ) {
          fetch("{% url 'delete_treatment_records' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ record_ids: recordIds }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                window.location.reload();
              } else {
                alert("Error deleting records");
              }
            });
        }
      }

      function prepareUpdate() {
        var selected = document.querySelector(
          'input[name="selected_record"]:checked'
        );
        if (selected) {
          fetch('{% url "get_treatment_record_details" %}', {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ record_id: selected.value }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                openUpdateModal(data.record);
              } else {
                alert("Failed to fetch record details.");
              }
            });
        } else {
          alert("Please select a record to update.");
        }
      }

      function openUpdateModal(record) {
        document.getElementById("modal-old-visit-id").value = record.visit_id;
        document.getElementById("modal-visit-id").value = record.visit_id;
        document.getElementById("modal-description").value = record.description;

        $("#updateTreatmentRecordModal").modal("show");
      }
    </script>
  </head>
  <body>
    <div class="header">
      <div>Welcome, {{ username }}</div>
      <button class="button" onclick="goback()">Return to Control Panel</button>
      <button class="button" onclick="location.href='logout'">Log Out</button>

      <div class="button-container">
        <button
          class="button toggle-button"
          id="toggleButton"
          onclick="toggleTable()"
        >
          Hide
        </button>
        <button class="button" onclick="gotoadd()">
          Add a Treatment Record
        </button>
        <button class="button" onclick="prepareUpdate()">
          Update Selected Record
        </button>
        <button class="button" onclick="deleteSelectedRecords()">
          Delete Selected Records
        </button>
        <button class="button" onclick="window.location.reload();">
          Refresh
        </button>
        <button
          class="button"
          data-toggle="modal"
          data-target="#smartFindModal"
        >
          Smart Find
        </button>
      </div>
    </div>
    <div class="container">
      <h1>Treatment Records</h1>

      <table id="treatmentRecordTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>Record_ID</th>
            <th>Visit_ID</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for record in treatment_records %}
          <tr
            data-record-id="{{ record.record_id }}"
            onclick="selectRow(this);"
          >
            <td>
              <input
                type="checkbox"
                name="selected_record"
                value="{{ record.record_id }}"
              />
            </td>
            <td>{{ record.record_id }}</td>
            <td>{{ record.visit_id }}</td>
            <td>{{ record.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Update Treatment Record Modal -->
    <div
      class="modal fade"
      id="updateTreatmentRecordModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="updateTreatmentRecordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateTreatmentRecordModalLabel">
              Update Treatment Record
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="updateTreatmentRecordForm">
              <input type="hidden" id="modal-old-visit-id" />
              <div class="form-group">
                <label>Visit ID:</label>
                <input type="text" id="modal-visit-id" class="form-control" />
              </div>
              <div class="form-group">
                <label>Description:</label>
                <textarea
                  id="modal-description"
                  class="form-control"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitUpdate()"
            >
              Save changes
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Structure -->
    <div
      class="modal fade"
      id="smartFindModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="smartFindModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="smartFindModalLabel">
              Enter Your Query
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              class="form-control"
              id="nlQueryInput"
              placeholder="Type your target"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitQueryButton"
            >
              Submit Query
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Structure for Query Results -->
    <div
      class="modal fade"
      id="queryResultsModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="queryResultsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <!-- Add modal-lg class here -->
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="queryResultsModalLabel">
              Query Results
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Record_ID</th>
                  <th>Visit_ID</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="queryResultTableBody">
                <!-- Results will be appended here -->
              </tbody>
            </table>
          </div>
          <div class="modal-body-single" style="display: none">
            <div
              id="queryResultBox"
              class="p-3"
              style="background-color: #f9f9f9; border: 1px solid #ddd"
            >
              <!-- Single result will be displayed here -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
