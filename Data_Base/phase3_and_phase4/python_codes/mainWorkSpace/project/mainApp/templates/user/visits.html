{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      href="{% static 'mainApp/images/logo.png' %}"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visits</title>
    <style>
      html,
      body {
        overflow-x: hidden;
        height: 100%;
      }

      .modal-lg {
        max-width: 90%;
      }

      .modal-body table {
        width: 100%;
        overflow-x: auto;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }

      .container {
        padding-top: 60px;
      }

      .button-container {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-bottom: 20px;
      }

      .button {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        white-space: nowrap;
      }

      .header {
        position: sticky;
        top: 0;
        z-index: 1000;
        width: 100%;
        background-color: #333;
        color: white;
        padding: 10px 20px;
      }

      .container {
        padding-top: 70px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .button-container {
        display: flex;
        flex-wrap: wrap;
      }

      .toggle-button {
        cursor: pointer;
        background-color: #4caf50;
        border: none;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
      }

      h1 {
        color: #333;
        display: inline-block;
        margin-right: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      th,
      td {
        text-align: left;
        padding: 8px;
        border: 1px solid #ddd;
      }

      th {
        background-color: #4caf50;
        color: white;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      .button {
        padding: 10px 20px;
        margin-top: 20px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .container {
        padding-top: 60px;
      }

      .toggle-button {
        cursor: pointer;
        background-color: #4caf50;
        border: none;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var submitButton = document.getElementById("submitQueryButton");
        if (submitButton) {
          submitButton.addEventListener("click", processNLQuery);
        }
      });

      function processNLQuery() {
        const query = document.getElementById("nlQueryInput").value;
        const url = "{% url 'process_query' %}";
        console.log("URL being called:", url);

        fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ query: query }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("Query result:", data.result);
              const resultTableBody = document.getElementById(
                "queryResultTableBody"
              );
              const resultBox = document.getElementById("queryResultBox");
              resultTableBody.innerHTML = "";
              resultBox.innerHTML = "";

              if (data.result.length === 1) {
                const singleResult = data.result[0];
                for (const key in singleResult) {
                  const div = document.createElement("div");
                  div.innerHTML = `<strong>${key}:</strong> ${singleResult[key]}`;
                  resultBox.appendChild(div);
                }
                $("#queryResultsModal").modal("show");
                $("#queryResultsModal .modal-body").hide();
                $("#queryResultsModal .modal-body-single").show();
              } else {
                data.result.forEach((visit) => {
                  const row = document.createElement("tr");
                  row.innerHTML = `
                                    <td>${visit["Visit_ID"]}</td>
                                    <td>${visit["patient_ID"]}</td>
                                    <td>${visit["Date"]}</td>
                                    <td>${visit["Time"]}</td>
                                `;
                  resultTableBody.appendChild(row);
                });
                $("#queryResultsModal").modal("show");
                $("#queryResultsModal .modal-body").show();
                $("#queryResultsModal .modal-body-single").hide();
              }
            } else {
              alert("Failed to process query: " + data.error);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      function submitUpdate() {
        var visitData = {
          visit_id: document.getElementById("modal-visit-id").value,
          patient_id: document.getElementById("modal-patient-id").value,
          date: document.getElementById("modal-date").value,
          time: document.getElementById("modal-time").value,
        };

        fetch("{% url 'update_visit' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
          body: JSON.stringify(visitData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              $("#updateVisitModal").modal("hide");
              window.location.reload();
            } else {
              alert("Failed to update visit.");
            }
          });
      }

      function gotoadd() {
        window.location.href = "{% url 'add_visit' %}";
      }

      function goback() {
        window.location.href = "{% url 'control' %}";
      }

      function toggleTable() {
        var table = document.getElementById("visitTable");
        var btn = document.getElementById("toggleButton");
        if (table.style.display === "none") {
          table.style.display = "";
          btn.textContent = "Hide";
        } else {
          table.style.display = "none";
          btn.textContent = "Show";
        }
      }

      function selectRow(row) {
        var checkbox = row.getElementsByTagName("input")[0];
        checkbox.checked = !checkbox.checked;
        row.style.backgroundColor = checkbox.checked ? "#f8d7da" : "";
      }

      function deleteSelectedVisits() {
        var selected = document.querySelectorAll(
          'input[name="selected_visit"]:checked'
        );
        var visitIds = Array.from(selected).map((input) => input.value);

        if (
          visitIds.length > 0 &&
          confirm("Are you sure you want to delete selected visits?")
        ) {
          fetch("{% url 'delete_visits' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ visit_ids: visitIds }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                window.location.reload();
              } else {
                alert("Error deleting visits");
              }
            });
        }
      }

      function prepareUpdate() {
        var selected = document.querySelector(
          'input[name="selected_visit"]:checked'
        );
        if (selected) {
          fetch('{% url "get_visit_details" %}', {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ visit_id: selected.value }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                openUpdateModal(data.visit);
              } else {
                alert("Failed to fetch visit details.");
              }
            });
        } else {
          alert("Please select a visit to update.");
        }
      }

      function openUpdateModal(visit) {
        document.getElementById("modal-visit-id").value = visit.visit_id;
        document.getElementById("modal-patient-id").value = visit.patient_id;
        document.getElementById("modal-date").value = visit.date;
        document.getElementById("modal-time").value = visit.time;

        $("#updateVisitModal").modal("show");
      }
    </script>
  </head>
  <body>
    <div class="header">
      <div>Welcome, {{ username }}</div>
      <button class="button" onclick="goback()">Return to Control Panel</button>
      <button class="button" onclick="location.href='logout'">Log Out</button>

      <div class="button-container">
        <button
          class="button toggle-button"
          id="toggleButton"
          onclick="toggleTable()"
        >
          Hide
        </button>
        <button class="button" onclick="gotoadd()">Add a Visit</button>
        <button class="button" onclick="prepareUpdate()">
          Update Selected Visit
        </button>
        <button class="button" onclick="deleteSelectedVisits()">
          Delete Selected Visits
        </button>
        <button class="button" onclick="window.location.reload();">
          Refresh
        </button>
        <button
          class="button"
          data-toggle="modal"
          data-target="#smartFindModal"
        >
          Smart Find
        </button>
      </div>
    </div>
    <div class="container">
      <h1>Visits</h1>

      <table id="visitTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>Visit_ID</th>
            <th>Patient_ID</th>
            <th>Date</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          {% for visit in visits %}
          <tr data-visit-id="{{ visit.visit_id }}" onclick="selectRow(this);">
            <td>
              <input
                type="checkbox"
                name="selected_visit"
                value="{{ visit.visit_id }}"
              />
            </td>
            <td>{{ visit.visit_id }}</td>
            <td>{{ visit.patient_id }}</td>
            <td>{{ visit.date }}</td>
            <td>{{ visit.time }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Update Visit Modal -->
    <div
      class="modal fade"
      id="updateVisitModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="updateVisitModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateVisitModalLabel">Update Visit</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="updateVisitForm">
              <input type="hidden" id="modal-visit-id" />
              <div class="form-group">
                <label>Patient ID:</label>
                <input type="text" id="modal-patient-id" class="form-control" />
              </div>
              <div class="form-group">
                <label>Date:</label>
                <input type="date" id="modal-date" class="form-control" />
              </div>
              <div class="form-group">
                <label>Time:</label>
                <input type="time" id="modal-time" class="form-control" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitUpdate()"
            >
              Save changes
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Structure -->
    <div
      class="modal fade"
      id="smartFindModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="smartFindModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="smartFindModalLabel">
              Enter Your Query
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input
              type="text"
              class="form-control"
              id="nlQueryInput"
              placeholder="Type your target"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="submitQueryButton"
            >
              Submit Query
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Structure for Query Results -->
    <div
      class="modal fade"
      id="queryResultsModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="queryResultsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <!-- Add modal-lg class here -->
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="queryResultsModalLabel">
              Query Results
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Visit_ID</th>
                  <th>Patient_ID</th>
                  <th>Date</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="queryResultTableBody">
                <!-- Results will be appended here -->
              </tbody>
            </table>
          </div>
          <div class="modal-body-single" style="display: none">
            <div
              id="queryResultBox"
              class="p-3"
              style="background-color: #f9f9f9; border: 1px solid #ddd"
            >
              <!-- Single result will be displayed here -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
